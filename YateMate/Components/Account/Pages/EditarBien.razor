@page "/bien/{Id:int?}"
@using YateMate.Aplicacion.UseCases.Bien
@rendermode InteractiveServer 
@inject ObtenerBienUseCase ObtenerBienUseCase
@inject ModificarBienUseCase ModificarBienUseCase
@inject AgregarBienUseCase AgregarBienUseCase
@inject IdentityUserAccessor UserAccessor
@inject NavigationManager Navegador;

@if (_err.Length > 1)
{
    <h3>@_err</h3>
}
@if (_esNuevoBien)
{
    <h3>Agregando un nuevo bien</h3>
}
else
{
    <h3>Modificando al bien con id "@_bien.Id"</h3>
}
<form @onsubmit="Aceptar">
    <label class="form-control">
        Nombre:
    <input placeholder="" @bind="_nombre" required="required">
    </label>
    <label class="form-control">
        Descripcion:
    <input placeholder="" @bind="_descripcion" required="required">
    </label>
    <label class="form-control">
        Imagen:
        <input placeholder="" @bind="_imagen" required="required">
    </label>
    <button type="submit" class="btn btn-primary">Aceptar</button>
</form>

@code {
    // [CascadingParameter] private HttpContext HttpContext { get; set; } = default!;
    // ApplicationUser _user;
    //
    // protected override async Task OnInitializedAsync()
    // {
    //     _user = await UserAccessor.GetRequiredUserAsync(HttpContext);
    // }
    
    bool _esNuevoBien = true;
    Bien _bien = new Bien("", "", "", "");
    string _err = "";
    string _nombre = "";
    string _descripcion = "";
    string _imagen = "";
    
    [Parameter] public int? Id { get; set; }
    protected override void OnParametersSet()
    {
        if (Id != null)
        {
            var bienHallado = ObtenerBienUseCase.Ejecutar(Id.Value);
            if (bienHallado != null)
            {
                _bien = bienHallado;
                _esNuevoBien = false;
            }
        }
    }
    void Aceptar()
    {
        try
        {
            // Console.WriteLine("Entro al try");
            _bien.Nombre = _nombre;
            _bien.Descripcion = _descripcion;
            _bien.UsuarioId = "1206f22b-e6b3-4e81-a1cf-68113e041056"; //harcodee para que se le agregue al id de natias, deberia ir _user.id pero no anda por el http context
            _bien.Imagen = _imagen;
            if (_esNuevoBien)
            {
                // Console.WriteLine("Entro al if");
                AgregarBienUseCase.Ejecutar(_bien);
            }
            else
            {
                ModificarBienUseCase.Ejecutar(_bien);
            }
            Navegador.NavigateTo("/ListarMisBienes");
            
        }
        catch (Exception e)
        {
            _err = e.Message;
        }
    }
}